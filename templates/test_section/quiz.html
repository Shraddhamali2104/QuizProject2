{% extends 'base.html' %}
{% block title %}Quiz{% endblock %}

{% block style_content %}
<style>
  #timer {
    z-index: 5;
    color: maroon;
    font-size: 50px;
  }

  .left-mcq-panel {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    /* color: black; */
  }

  .left-mcq-panel button {
    width: 50px;
    height: 50px;
    border: 1px solid white;
    background-color: white;
    color: black;
    margin: 20px;
    /* Adjust spacing between buttons */
  }


  .left-mcq-panel button.notattempted {
    background-color: firebrick;
  }

  .left-mcq-panel button.attempted {
    background-color: yellowgreen;
  }

  .left-mcq-panel button.review {
    background-color: darkslateblue;

  }

  .left-mcq-panel button.active {
    background-color: green !important;
  }
</style>
{% endblock %}

{% block middle_content %}
<!-- left block content -->
<div class="container text-center mt-5">
  <div class="row justify-content-evenly align-items-center ">
    <div class="col-md-4">
      <!-- Hidden input field to pass the updated timer value -->
      
      <input type="hidden" id="index" value="{{ index }}" />
      
      <div id="row_data" hidden> {{ row_data|tojson|safe }} </div>
      
      <div class="left-mcq-panel">
        <div class="timer" id="timer"> Countdown Will start Soon ... </div>
        <!-- Loop through the number of questions -->
        {% for question_number in range(1, basic_data[2] + 1) %}
        {% if (question_number - 1) % 3 == 0 %}
        <!-- Start a new button group for every 3rd button -->
        <div class="button-group">
          {% endif %}
          <button type="button" name="select{{ question_number }}"
            onclick="goToSelectedQuestion({{ question_number}})">{{
            question_number }}</button>

          {% if question_number % 3 == 0 or question_number == basic_data[2] %}
          <!-- End the button group for every 3rd button or at the last button -->
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    <div class="col-md-8">
      <!-- Generate quiz -->
      <div class="container" style="height: auto; width: 40rem">
        <!-- progress bar -->
        <div class="progress mt-3" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0"
          aria-valuemax="100">
          <div class="progress-bar bg-success" style="width: 25%">25%</div>
        </div>

        <form id="quiz-form" action="/submit" method="POST">
          <!-- Other form elements -->

          <!-- <input type="hidden" name="test_id" value="{{row_data[index][1]}}"> -->
          <input type="hidden" name="time_taken" id="time_taken" value="{{ basic_data[1] }}" />
          <!-- <input type="hidden" id="time_taken" name="time_taken" value="0" /> -->
          <input type="hidden" id="total_score" name="total_score" value="0" />
          <input type="hidden" name="test_id" value="{{basic_data[0]}}">

          {% if row_data %}
          <div id="question-container" class="mt-3" >

            <p>Question Number: {{ index + 1 }}:</p>
            <h3 class="font-weight-bold mb-4">{{ row_data[index][0] }}</h3>
            <!-- Display the question -->

            <!-- Hidden input field to store the correct answer -->
            <input type="hidden" name="correct_answer" value="{{ row_data[index][5] }}" />

            <div class="row mb-3">
              <div class="col-md-6">
                <input type="radio" id="option1" name="answer" value="{{ row_data[index][1] }}" />
                <label for="option1" class="ans_font">{{ row_data[index][1] }}</label>
              </div>
              <div class="col-md-6">
                <input type="radio" id="option2" name="answer" value="{{ row_data[index][2] }}" />
                <label for="option2" class="ans_font">{{ row_data[index][2] }}</label>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <input type="radio" id="option3" name="answer" value="{{ row_data[index][3] }}" />
                <label for="option3" class="ans_font">{{ row_data[index][3] }}</label>
              </div>
              <div class="col-md-6">
                <input type="radio" id="option4" name="answer" value="{{ row_data[index][4] }}" />
                <label for="option4" class="ans_font">{{ row_data[index][4] }}</label>
              </div>
            </div>


            <div class="button-group">
              <!-- prev button  -->
              <button type="button" name="prev" onclick="prevQuestion()" class="btn btn-secondary mr-2" {% if index <= 0 %} disabled {% endif %}>Previous</button>

              <!-- review button  -->
              <button type="button" name="review" onclick="markForReview()" class="btn btn-secondary mr-2"> Review </button>

              <!-- next button -->
              <button type="button" name="next" onclick="nextQuestion()" class="btn btn-primary mr-2" {% if index >= row_data|length - 1 %} disabled {% endif %}>Next</button>


            </div>
            <button type="button" name="submitQuizButton" class="btn btn-success mr-2" onclick="submitQuiz()"> Submit </button>

          </div>
          {% else %}
          <p>No questions available.</p>
          {% endif %}

        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Pass the row_data variable to JavaScript
  // convert the string into the javascript object 
  var row_data = JSON.parse(document.getElementById("row_data").innerText);

  // console.log(row_data);
  // Array to store user's selected answers
  var userAnswers = new Array(row_data.length).fill(null);

  // Get the initial value of index from the hidden input field i.e String to integer
  var index = parseInt(document.getElementById("index").value);
  // var index = 0;

  // Set the timer duration in seconds
  var timerDuration = parseInt(document.getElementById("time_taken").value); // 10 minutes
  const timerDuration2 = timerDuration; //store the initial total duration of the quiz timer in seconds

  // Function to update the selected answer for a question
  function updateSelectedAnswer(questionIndex, selectedAnswer) {
    userAnswers[questionIndex] = selectedAnswer;
    console.log(" userAnswers" + userAnswers) //This line logs the updated userAnswers array to the browser's console for debugging purposes.
  }

  // Function to calculate and update the total score
  function calculateTotalScore() {
    var totalScore = 0;
    // Iterate through all questions and check user's answers
    for (var i = 0; i < row_data.length; i++) {
      var correctAnswer = row_data[i][5]; // Correct answer for the current question
      var userAnswer = userAnswers[i]; // User's selected answer for the current question
      if (userAnswer === correctAnswer) { // Check if user answered correctly
        totalScore++;
      }
    }
    document.getElementById('total_score').value = totalScore; // Update the total score input field
  }

  // Function to update the countdown timer
  function updateTimer() {
    if (timerDuration >= 0) {
      var minutes = Math.floor(timerDuration / 60);
      var seconds = timerDuration % 60;
      document.getElementById("timer").innerText =
        minutes.toString().padStart(2, "0") +
        ":" +
        seconds.toString().padStart(2, "0");//ensure that both minutes and seconds are displayed as two-digit numbers.
      // document.getElementById("time_taken").value =
      //   timerDuration.toString();
      timerDuration--; // Decrease timer duration by 1 second

      if (timerDuration < 0) {
        // Submit the quiz when timer reaches 00
        submitQuiz();
        clearInterval(timerInterval); // Stop the countdown
      }
    }
  }

  // Update the timer every second
  var timerInterval = setInterval(updateTimer, 1000);

  function markAttemptorNotAttempt(bool) {
    let selectedButton = document.querySelector(`[name="select${index + 1}"]`);
    selectedButton.classList.remove('active');//to change the visual appearance or behavior of the button on the webpage.

    if (bool) {
      selectedButton.classList.add('attempted');
    }
    else {
      selectedButton.classList.add('notattempted');
    }
  }

  function markActive(markIndex) {
    let selectedButton = document.querySelector(`[name="select${markIndex + 1}"]`);
    selectedButton.classList.add('active');
  }

  function markForReview() {
    let selectedButton = document.querySelector(`[name="select${index + 1}"]`);
    selectedButton.classList.toggle('review');
  }

  // Function to move to the next question
  function nextQuestion() {
    let selectedAnswer = document.querySelector(`input[name="answer"]:checked`);
    if (selectedAnswer) {
      markAttemptorNotAttempt(true);
      updateSelectedAnswer(index, selectedAnswer.value);

    } else {
      markAttemptorNotAttempt(false);
    }
    if (index < row_data.length - 1) {
      index++; // Increase the question index
      displayQuestion();
      // Add 'active' class to the clicked button
      markActive(index);
    }
  }

  // Function to move to the previous question
  function prevQuestion() {
    let selectedAnswer = document.querySelector(`input[name="answer"]:checked`);
    if (selectedAnswer) {
      markAttemptorNotAttempt(true);
      updateSelectedAnswer(index, selectedAnswer.value);
    } else {
      markAttemptorNotAttempt(false);
    }
    if (index > 0) {
      index--; // Decrease the question index
      displayQuestion();
      // Add 'active' class to the clicked button
      markActive(index);
    }
  }

  function goToSelectedQuestion(goToIndex) {
    let selectedAnswer = document.querySelector(`input[name="answer"]:checked`);
    if (selectedAnswer) {
      markAttemptorNotAttempt(true);
      updateSelectedAnswer(index, selectedAnswer.value);

    } else {
      markAttemptorNotAttempt(false);
    }

    index = goToIndex - 1;
    displayQuestion();

    // Add 'active' class to the clicked button
    markActive(index);

  }

  // Function to display the current question
  function displayQuestion() {
    const questionContainer = document.getElementById('question-container');
    
    questionContainer.innerHTML = `
        <p>Question Number: ${index + 1}:</p>
        <h3 class="font-weight-bold mb-4">${row_data[index][0]}</h3>
        <input type="hidden" name="correct_answer" value="${row_data[index][5]}" />
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="radio" id="option1" name="answer" value="${row_data[index][1]}" />
                <label for="option1" class="ans_font">${row_data[index][1]}</label>
            </div>
            <div class="col-md-6">
                <input type="radio" id="option2" name="answer" value="${row_data[index][2]}" />
                <label for="option2" class="ans_font">${row_data[index][2]}</label>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="radio" id="option3" name="answer" value="${row_data[index][3]}" />
                <label for="option3" class="ans_font">${row_data[index][3]}</label>
            </div>
            <div class="col-md-6">
                <input type="radio" id="option4" name="answer" value="${row_data[index][4]}" />
                <label for="option4" class="ans_font">${row_data[index][4]}</label>
            </div>
        </div>
        <div class="button-group">
            <button type="button" name="prev" onclick="prevQuestion()" class="btn btn-secondary mr-2" ${index <= 0 ? 'disabled' : ''}>Previous</button>
            <button type="button" name="review" onclick="markForReview()" class="btn btn-secondary mr-2">Review</button>
            <button type="button" name="next" onclick="nextQuestion()" class="btn btn-primary mr-2" ${index >= row_data.length - 1 ? 'disabled' : ''}>Next</button>
        </div>
        <button type="button" name="submitQuizButton" class="btn btn-success mr-2" onclick="submitQuiz()">Submit</button>
    `;

}

  // Function to submit the quiz
  function submitQuiz() {
    // console.log("submitQuiz() function called.");
    let selectedAnswer = document.querySelector(`input[name="answer"]:checked`);
    if (selectedAnswer) {
      markAttemptorNotAttempt(true);
      updateSelectedAnswer(index, selectedAnswer.value);

    } else {
      markAttemptorNotAttempt(false);
    }

    document.getElementById("time_taken").value = (timerDuration2 - timerDuration).toString();
    // time_taken = document.getElementById("time_taken").value;
    //final logic to submit quiz
    calculateTotalScore();
    document.getElementById("quiz-form").submit();
  }

</script>
{% endblock %}